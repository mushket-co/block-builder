# Changelog

Все важные изменения в проекте будут документироваться в этом файле.

Формат основан на [Keep a Changelog](https://keepachangelog.com/ru/1.0.0/),
и проект следует [Semantic Versioning](https://semver.org/lang/ru/).


## [1.0.26] - 2025-11-16

### Добавлено
- Новые утилиты: `scrollLock` и `repeaterCountText` для улучшения UX списков и модалок
- Типы: добавлен `src/types/vue-shim.d.ts` для корректной работы деклараций Vue в пакете
- Типы (repeater): добавлено свойство `countLabelVariants` в `IRepeaterFieldConfig` для задания форм слова в счётчике (`one/few/many/zero`)
- Иконки для примеров: добавлены SVG в `examples/static/icons` (accordion, button, card, divider, form, gallery, hero, image, rich-text, slider, spaced-text, spacer, tabs, text, video)
- Scroll Lock API: возможность глобального переопределения поведения через `setScrollLockHandlers({ lock, unlock })`

### Изменено
- Block configs (icon): свойство `icon` унифицировано — ожидается URL (или путь) для `<img>`. Отрисовка и в Vue, и в Pure‑JS приводится к единому виду
- Компоненты форм Vue3 (`FormField` семейство, `ApiSelectField.vue`, `SelectField.vue`, `CheckboxField.vue`, `RadioField.vue`, `TextField.vue`, `TextareaField.vue`, `NumberField.vue`, `ImageUploadField.vue`, `SpacingControl.vue`, `RepeaterControl.vue`) — улучшен UX, единообразие состояний, валидация и управление фокусом
- Кастомный дропдаун (`CustomDropdown.vue`) — стабилизировано позиционирование, управление клавиатурой, сохранение/восстановление скролла, улучшена работа на мобильных с виртуальной клавиатурой
- Рендереры и контроллеры UI (`ApiSelectControlRenderer`, `SelectControlRenderer`, `SpacingControlRenderer`, `RepeaterControlRenderer`, `CustomFieldControlRenderer`, `UIRenderer`, `ModalManager`, `BlockUIController`) — унификация API, корректное снятие обработчиков, улучшение производительности и предсказуемости состояний
- Формы и типы (`src/core/types/form.ts`, `BlockBuilderFacade.ts`) — синхронизация типов и публичного API
- Стили (`_base.scss`, `_utilities.scss`, `_variables.scss`, компоненты в `src/ui/styles/components/*`, `index.scss`) — унификация токенов, состояний и БЭМ-структуры; исправление визуальных артефактов
- Примеры (`examples/*` включая `pure-js-vite`, `vue3`, `vue3-core-api`, `pure-js-cdn`, `api-usage`) — обновлены конфиги блоков и демо для новых возможностей
- `package.json` — обновление версии и экспорта для согласованности c типами/точками входа
- Repeater (счётчик): по умолчанию отображается только число; при наличии `countLabelVariants` — формат “число + слово”. Логика вынесена в общий util `repeaterCountText` и используется в Vue и pure‑js
- Spacing (pure‑js): разметка унифицирована с Vue — добавлен внутренний контейнер `bb-spacing-control` внутри `bb-spacing-control-container`
- CSS классы: повсеместная замена хардкоженных строк на `CSS_CLASSES` в JS/TS частях (поиск, скролл, селекторы)

### Исправлено
- Api Select: корректное позиционирование выпадающего списка в скроллируемых контейнерах, стабильная работа загрузки/дозагрузки и сохранение позиции скролла
- Api Select (pure‑js): исправлен поиск контейнеров по `CSS_CLASSES.API_SELECT_CONTROL_CONTAINER` — устранено зависание “⏳ Инициализация...”
- Select/Checkbox/Radio: корректное отображение активного/disabled/invalid состояний, синхронизация значения и отображения
- Modal/Overlay: устранены утечки обработчиков, улучшено блокирование скролла страницы
- UIRenderer/BlockUIController: предсказуемое удаление/размонтирование UI, корректная инициализация контролов
- Безопасность DOM: улучшена безопасность вспомогательных утилит (`safeDOM`, `domSafe`, `formErrorHelpers`)
- Валидация/скролл: корректный скролл к первому невалидному полю изображения внутри repeater (унификация селекторов и поиска поля)

### Удалено
- `examples/vue3/src/components/*` устаревшие компоненты демо (перенос/замена на актуальные примеры блоков)


## [1.0.24] - 2025-11-13

### Исправлено
- **FetchHttpClient.ts**: Исправлена обработка относительных URL - теперь `fetch()` корректно работает с относительными путями (например, `/api/news`). Используется `new URL(url, base)` для правильной обработки query параметров при сохранении относительного формата URL
- **ApiSelectUseCase.ts**: Улучшена валидация конфигурации - теперь относительные URL (начинающиеся с `/`) считаются валидными наряду с абсолютными URL
- **ApiSelectField.vue**: Исправлена позиция дропдауна при открытии - добавлено обновление позиции при открытии дропдауна, особенно важно для полей в репитере, которые могут быть в скроллируемой области. Позиция также обновляется после загрузки данных и после завершения загрузки
- **SpacingFieldRenderer.ts**: Исправлена структура передачи breakpoints - теперь `spacingConfig` передается как `config`, что позволяет корректно извлекать кастомные breakpoints из `spacingOptions.config.breakpoints` в pure-js версии
- **mock-api-server.js** (vue3 и pure-js-vite): Добавлена обработка эндпоинта `/api/articles` для поддержки api-select полей с относительными URL в блоках "Богатые карточки" и других блоках

### Изменено
- **ApiSelectField.vue**: Улучшено обновление позиции дропдауна - позиция обновляется при открытии, после загрузки данных и после завершения загрузки для корректного отображения в скроллируемых контейнерах

## [1.0.23] - 2025-11-13

### Добавлено
- **CustomDropdown.vue**: Создан универсальный компонент дропдауна для Vue3 с поддержкой одиночного и множественного выбора, клавиатурной навигации, позиционирования с учетом viewport и виртуальной клавиатуры, обнаружения прокручиваемых предков
- **BaseDropdownRenderer.ts**: Базовый класс для рендереров дропдаунов в pure-JS с общей логикой позиционирования, открытия/закрытия, обработки событий
- **SelectControlRenderer.ts**: Реализация кастомного select контрола для pure-JS на основе BaseDropdownRenderer с поддержкой клавиатурной навигации, сохранения позиции скролла при обновлении
- **_dropdown.scss**: Стили для универсального компонента дропдауна с поддержкой всех состояний (открыт, disabled, invalid, multiple)
- **Методы сохранения скролла**: Добавлены методы `saveScrollPosition()` и `restoreScrollPosition()` в CustomDropdown для сохранения позиции скролла при подгрузке данных

### Изменено
- **ApiSelectField.vue**: Рефакторинг на использование CustomDropdown компонента, добавлено сохранение позиции скролла при подгрузке новых элементов через API
- **SelectField.vue**: Рефакторинг на использование CustomDropdown компонента вместо нативного `<select>`
- **SelectFieldRenderer.ts**: Переработан для использования SelectControlRenderer вместо нативного `<select>` в pure-JS версии
- **BlockUIController.ts**: Добавлена инициализация select контролов через метод `initializeSelectControls()` для автоматической инициализации кастомных селектов
- **ApiSelectControlRenderer.ts**: Исправлено сохранение позиции скролла при обновлении списка в multi-select режиме
- **IFormFieldConfig**: Добавлено поле `multiple?: boolean` для поддержки множественного выбора в select полях
- **Опции полей**: Обновлен тип опций - добавлена поддержка `value: string | number` и `disabled?: boolean`
- **IRenderContext**: Добавлен метод `onFieldChange` для callback изменения значений полей
- **Стили api-select**: Исправлен двойной бордер в api-select во Vue3 - убран бордер у `.bb-dropdown__control` внутри `.bb-api-select__search`

### Исправлено
- **UX api-select Vue3**: При подгрузке новых элементов список больше не возвращается в начало, сохраняется текущая позиция скролла
- **UX select pure-JS**: При выборе элемента в multi-select режиме сохраняется позиция скролла, список не возвращается в начало
- **Отображение значения select**: Исправлено обновление отображаемого значения в закрытом состоянии селекта после выбора элемента
- **Двойной лейбл select**: Убран дублирующийся лейбл в select полях (лейбл рендерится только один раз через BaseFieldRenderer)
- **Двойной бордер api-select**: Исправлен двойной бордер в api-select во Vue3 версии

## [1.0.22] - 2025-11-09

### Добавлено
- **Vue form-fields**: Добавлен каталог `src/ui/components/form-fields/` с базовыми Vue-компонентами полей (`TextField`, `TextareaField`, `NumberField`, `ColorField`, `SelectField`, `CheckboxField`, `RadioField`) и универсальным `FormField` для повторного использования UI-логики.
- **IRenderContext**: Новый интерфейс `IRenderContext`, передающий классы, data-атрибуты и состояние ошибок в рендереры форм без постобработки HTML.

### Изменено
- **BlockBuilder.vue и RepeaterControl.vue**: Формы переписаны на `FormField`, устранено дублирование шаблонов, унифицированы ошибки и стили.
- **RepeaterControlRenderer и form-renderers**: Рендереры обновлены для работы с `IRenderContext`; удалены строковые замены, добавлена передача контекста и спец-атрибутов для repeater и image полей.
- **ApiSelectControlRenderer, BlockUIController, EventDelegation**: Адаптированы к новой архитектуре, улучшено управление обработчиками и состояниями UI.
- **Стили repeater**: Унифицированы с общими классами форм, настроена поддержка новых компонентов.
- **package.json, index.ts, core.ts, vue.ts**: Обновлены экспорты и точки входа для новых компонентов и типов.

### Удалено
- **utils/validation.ts**: Удалён устаревший модуль валидации; функциональность перенесена в актуальные сервисы и компоненты.

## [1.0.21] - 2025-11-08

### Добавлено
- **ESLint и Prettier**: Добавлена конфигурация ESLint и Prettier для обеспечения единообразия кода и автоматического форматирования. Добавлены скрипты `lint`, `lint:fix` и `format` в package.json
- **LICENSE-PRO.md**: Добавлен файл с описанием PRO лицензии для коммерческого использования расширенных функций

### Изменено
- **LICENSE**: Обновлен файл лицензии с указанием на PRO версию для коммерческого использования
- **Форматирование кода**: Весь код отформатирован в соответствии с правилами Prettier для единообразия стиля
- **Код-стайл**: Применены правила ESLint для улучшения качества кода и предотвращения потенциальных ошибок

---

## [1.0.20] - 2025-11-08

### Добавлено
- **Система рендереров полей формы**: Реализована новая архитектура рендеринга полей формы с использованием паттерна Factory и базового класса `BaseFieldRenderer`. Все типы полей теперь имеют отдельные классы-рендереры (TextFieldRenderer, TextareaFieldRenderer, NumberFieldRenderer, ColorFieldRenderer, UrlFieldRenderer, EmailFieldRenderer, FileFieldRenderer, CheckboxFieldRenderer, SelectFieldRenderer, RadioFieldRenderer, ImageFieldRenderer, SpacingFieldRenderer, RepeaterFieldRenderer, ApiSelectFieldRenderer, CustomFieldRenderer)
- **FieldRendererFactory**: Добавлен фабричный класс для управления рендерерами полей с поддержкой регистрации кастомных рендереров

### Изменено
- **FormBuilder**: Переработан для использования новой системы рендереров через `FieldRendererFactory`. Улучшена модульность и расширяемость кода
- **Безопасность рендеринга**: Все рендереры полей теперь используют метод `escapeHtml()` для экранирования HTML в лейблах, значениях и плейсхолдерах
- **UIRenderer**: Добавлено корректное удаление Vue приложений через `unmount()` при удалении блоков для предотвращения утечек памяти
- **ModalManager**: Улучшена обработка событий - добавлено корректное удаление обработчиков событий в методе `closeModal()`. Заголовки и тексты кнопок теперь экранируются для безопасности
- **EventDelegation**: Добавлено корректное удаление глобального обработчика событий в методе `destroy()`. Добавлена валидация размера данных в `data-args` (максимум 10000 символов) и обработка ошибок парсинга JSON

### Исправлено
- **Утечки памяти Vue приложений**: Исправлена утечка памяти при использовании Vue компонентов в pure-js версии - теперь Vue приложения корректно удаляются через `app.unmount()` при удалении блоков
- **Утечки памяти в ModalManager**: Исправлена утечка памяти - обработчики событий теперь корректно удаляются при закрытии модального окна
- **Утечки памяти в EventDelegation**: Исправлена утечка памяти - глобальный обработчик событий теперь корректно удаляется в методе `destroy()`
- **XSS уязвимости**: Исправлены XSS уязвимости при отображении ошибок валидации, заголовков модальных окон и текстов кнопок - все пользовательские данные теперь экранируются через `escapeHtml()`
- **Безопасность JSON.parse**: Добавлена валидация размера данных и обработка ошибок при парсинге JSON в `EventDelegation`
- **Безопасность рендеринга полей**: Все рендереры полей теперь безопасно экранируют HTML во всех местах, где отображается пользовательский ввод

### ⚠️ Важные замечания по безопасности
- **Базовая защита от XSS**: В пакете реализована базовая защита от XSS атак через экранирование HTML во всех стандартных рендерерах полей формы. Однако **настоятельно рекомендуется** использовать дополнительную защиту в вашем приложении:
  - Для кастомных полей (`custom` тип поля) и кастомных рендереров (`ICustomFieldRenderer`) пакет **не может гарантировать** безопасность, так как рендеринг полностью контролируется пользователем. Обязательно используйте санитизацию (например, DOMPurify) при рендеринге HTML в кастомных полях
  - Для пользовательских HTML шаблонов в блоках (когда используется `render.kind === 'template'`) рекомендуется использовать санитизацию HTML, если шаблон может содержать пользовательский ввод
  - Для Vue компонентов в блоках используйте безопасные методы рендеринга (`v-text` вместо `v-html`, если не уверены в источнике данных)
  - Рекомендуется настроить Content Security Policy (CSP) в вашем приложении для дополнительной защиты от XSS атак

---

## [1.0.19] - 2025-11-05

### Исправлено
- -fix

---

## [1.0.18] - 2025-11-05

### Исправлено
- -fix

---

## [1.0.17] - 2025-11-05

### Изменено
- **BlockBuilder.vue и UIRenderer.ts**: Добавлен класс `block-builder` к основному контейнеру приложения для улучшения кастомизации стилей
- **_forms.scss**: Удален жестко заданный цвет из `.block-builder-form-label` для лучшей адаптации к темам

---

## [1.0.16] - 2025-11-04

### Исправлено
- **BlockBuilder.vue**: Исправлено отображение ошибок валидации - теперь ошибки показываются для всех типов полей (text, textarea, number, color, url, select, checkbox, radio), а не только для radio полей

---

## [1.0.15] - 2025-11-04

### Удалено
- **Свойство `storageType`**: Удалено свойство `storageType?: 'memory' | 'localStorage'` из `IBlockBuilderOptions` и `BlockBuilderFactory`. Сохранение блоков теперь реализовано исключительно через колбэк `onSave`, который пользователь передаёт в опциях
- **LocalStorageBlockRepositoryImpl**: Удалена реализация репозитория с использованием localStorage. Репозиторий теперь используется только для работы в памяти во время сессии
- **Свойство `collapsible`**: Удалено опциональное свойство `collapsible` из `IRepeaterFieldConfig`. Элементы repeater теперь всегда можно сворачивать/разворачивать (аккордеоны всегда включены)
- **Свойство `locked`**: Удалена функциональность блокировки блоков ("Lock block"). Удалены связанные методы и UI элементы
- **Методы `saveBlocks` и `loadBlocks`**: Удалены из документации как несуществующие публичные методы. Реальное сохранение происходит через колбэк `onSave`, загрузка - через `initialBlocks` prop

### Изменено
- **Валидация `message`**: Поле `message` в правилах валидации (`IValidationRule`, `IBaseValidationRule`) теперь опциональное. Добавлены fallback сообщения по умолчанию для всех типов правил валидации
- **Фильтрация скрытых блоков**: Если блок скрыт (`visible: false`), он автоматически фильтруется и не отображается при `isEdit: false`
- **Замена CSS классов**: Все использования CSS класса `hidden` и `is-hidden` заменены на `CSS_CLASSES.HIDDEN` из `block-builder/src/utils/constants.ts`
- **Унификация стилей**: Все стили из `<style>` секций в `BlockBuilder.vue` и `BlockComponent.vue` перемещены в общие SCSS файлы (`_forms.scss` и `_blocks.scss`)
- **RepeaterControl**: Элементы repeater теперь всегда можно сворачивать/разворачивать (аккордеоны всегда включены). Удалён prop `collapsible` из компонента

### Исправлено
- **RepeaterControl.vue**: Исправлена ошибка `TypeError: Cannot read properties of undefined (reading 'ERROR')` - добавлен `CSS_CLASSES` в возвращаемый объект `setup()` функции
- **Документация**: Исправлена ошибочная информация о `containerId` для core версии - теперь явно указано, что `containerId` НЕ нужен для `@mushket-co/block-builder/core`
- **Документация**: Удалены упоминания устаревших свойств `storage`, `autoRender` из документации. Исправлено на `autoInit`
- **Документация**: Добавлены все пропсы `BlockBuilderComponent` в документацию, удалены расплывчатые формулировки "другие опции..."

### Очистка кода
- Удалены неиспользуемые импорты, комментарии и мусорный код
- Удалена функция `handleCardClick` из `BlockComponent.vue`
- Удалены константы связанные с localStorage (`STORAGE_KEY_BLOCKS`, `STORAGE_QUOTA_EXCEEDED`, `FAILED_TO_LOAD_BLOCKS`, `FAILED_TO_SAVE_BLOCKS`)

---

## [1.0.14] - 2025-11-03

### Добавлено
- **Экспорт `./BlockBuilderFactory` в package.json**: Добавлен новый entry point `./BlockBuilderFactory` для доступа к `ApiSelectUseCase` и связанным типам (`IHttpClient`, `IHttpResponse`, `IHttpRequestOptions`, `IApiRequestParams`) из Pure JS приложений без необходимости импортировать Vue-специфичные модули

### Изменено
- **BlockBuilderFactory.ts**: Добавлены экспорты `ApiSelectUseCase` и связанных типов для использования вне пакета через импорт `@mushket-co/block-builder/BlockBuilderFactory`

---

## [1.0.13] - 2025-11-03

### Добавлено
- **Экспорты CSS в package.json**: Добавлены экспорты `./index.esm.css` и `./index.css` в `package.json`, что позволяет корректно импортировать стили через `import '@mushket-co/block-builder/index.esm.css'` без указания полного пути `dist/index.esm.css`

---

## [1.0.12] - 2025-11-03

### Исправлено
- **Исправлен `.npmignore`**: Убрано исключение всей директории `src/`, которое блокировало включение файлов из `src/ui/` в npm пакет. Теперь все файлы из `src/`, указанные в `files`, корректно включаются в пакет
- **Убрана зависимость от SCSS в Vue компонентах**: Удалены импорты SCSS файлов из Vue компонентов (`@use '../styles/index.scss'` и подобные). Теперь пользователям не нужно устанавливать `sass` - стили уже скомпилированы в `dist/index.esm.css` и должны импортироваться отдельно
- **Исключены SCSS файлы из npm пакета**: Директория `src/ui/styles/` теперь исключена из публикации пакета

---

## [1.0.11] - 2025-11-03

### Исправлено
- **Исправлен список файлов npm пакета**: Теперь включены все необходимые директории (`src/ui/**/*`, `src/core/**/*.ts`) для корректной работы Vue компонентов с их зависимостями (icons, controllers, services и т.д.)

---

## [1.0.10] - 2025-11-03

### Исправлено
- **Добавлены `core/services` и `core/entities` в npm пакет**: Файлы из `src/core/services/` и `src/core/entities/` теперь включены в список файлов пакета, что позволяет Vue компонентам корректно резолвить импорты лицензионных сервисов

---

## [1.0.9] - 2025-11-03

### Исправлено
- **Добавлен `BlockBuilderFactory.ts` в npm пакет**: Файл `src/BlockBuilderFactory.ts` теперь включен в список файлов пакета, что позволяет корректно резолвить импорты при использовании `vue` entry point

---

## [1.0.8] - 2025-11-03

### Исправлено
- **Исправлена проблема с резолвингом импортов в `vue` entry point**: Теперь `createBlockManagementUseCase` корректно работает при установке пакета через npm, добавлен экспорт `BlockBuilderFactory` через `vue.ts` для внешнего использования

### Изменено
- **vue.ts**: Добавлен экспорт `BlockBuilderFactory` и его типов для удобного использования в Vue компонентах

---

## [1.0.7] - 2025-11-03

### Исправлено
- **Исправлена проблема с резолвингом импортов в `vue` entry point**: Теперь `createBlockManagementUseCase` корректно работает при установке пакета через npm, добавлен экспорт `BlockBuilderFactory` через `vue.ts` для внешнего использования

### Изменено
- **vue.ts**: Добавлен экспорт `BlockBuilderFactory` и его типов для удобного использования в Vue компонентах

---

## [1.0.6] - 2025-11-03

### Добавлено
- **Режим редактирования/просмотра**: Добавлен параметр `isEdit` в `BlockBuilderFacade`, который позволяет переключаться между режимом редактирования (по умолчанию `true`) и режимом только просмотра (`false`)
- **API для управления режимом редактирования**: Добавлены методы `setIsEdit(isEdit: boolean)` и `getIsEdit(): boolean` в `BlockBuilderFacade` для динамического переключения режима
- **Условное отображение UI контролов**: В режиме просмотра (`isEdit: false`) автоматически скрываются все кнопки редактирования, добавления и управления блоками. Остаётся доступной только функция копирования ID блока
- **CSS класс `bb-is-edit-mode`**: Автоматически добавляется класс на элемент `body` для возможности кастомизации стилей в зависимости от режима работы

### Изменено
- **BlockBuilderFacade**: Добавлен параметр `isEdit` в интерфейс `IBlockBuilderOptions`, по умолчанию `true`
- **BlockUIController**: Добавлена поддержка режима редактирования, все операции создания/редактирования/удаления блоков блокируются в режиме просмотра
- **UIRenderer**: Обновлён для поддержки условного рендеринга контролов в зависимости от режима редактирования
- **BlockBuilder.vue**: Компонент теперь получает и обрабатывает проп `isEdit` для Vue3 интеграции
- **Примеры использования**: Обновлены примеры в `examples/pure-js-vite`, `examples/vue3` и `examples/pure-js-cdn` для демонстрации использования режима редактирования

### Исправлено
- Улучшена обработка режима просмотра в UI контроллере - все действия, связанные с редактированием, корректно блокируются

---

**Примечание**: Для полной истории изменений см. [git log](https://github.com/mushket-co/block-builder/commits/master).

