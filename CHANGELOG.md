# Changelog

Все важные изменения в проекте будут документироваться в этом файле.

Формат основан на [Keep a Changelog](https://keepachangelog.com/ru/1.0.0/),
и проект следует [Semantic Versioning](https://semver.org/lang/ru/).

## [1.0.20] - 2025-01-XX

### Добавлено
- **Система рендереров полей формы**: Реализована новая архитектура рендеринга полей формы с использованием паттерна Factory и базового класса `BaseFieldRenderer`. Все типы полей теперь имеют отдельные классы-рендереры (TextFieldRenderer, TextareaFieldRenderer, NumberFieldRenderer, ColorFieldRenderer, UrlFieldRenderer, EmailFieldRenderer, FileFieldRenderer, CheckboxFieldRenderer, SelectFieldRenderer, RadioFieldRenderer, ImageFieldRenderer, SpacingFieldRenderer, RepeaterFieldRenderer, ApiSelectFieldRenderer, CustomFieldRenderer)
- **FieldRendererFactory**: Добавлен фабричный класс для управления рендерерами полей с поддержкой регистрации кастомных рендереров

### Изменено
- **FormBuilder**: Переработан для использования новой системы рендереров через `FieldRendererFactory`. Улучшена модульность и расширяемость кода
- **Безопасность рендеринга**: Все рендереры полей теперь используют метод `escapeHtml()` для экранирования HTML в лейблах, значениях и плейсхолдерах
- **UIRenderer**: Добавлено корректное удаление Vue приложений через `unmount()` при удалении блоков для предотвращения утечек памяти
- **ModalManager**: Улучшена обработка событий - добавлено корректное удаление обработчиков событий в методе `closeModal()`. Заголовки и тексты кнопок теперь экранируются для безопасности
- **EventDelegation**: Добавлено корректное удаление глобального обработчика событий в методе `destroy()`. Добавлена валидация размера данных в `data-args` (максимум 10000 символов) и обработка ошибок парсинга JSON

### Исправлено
- **Утечки памяти Vue приложений**: Исправлена утечка памяти при использовании Vue компонентов в pure-js версии - теперь Vue приложения корректно удаляются через `app.unmount()` при удалении блоков
- **Утечки памяти в ModalManager**: Исправлена утечка памяти - обработчики событий теперь корректно удаляются при закрытии модального окна
- **Утечки памяти в EventDelegation**: Исправлена утечка памяти - глобальный обработчик событий теперь корректно удаляется в методе `destroy()`
- **XSS уязвимости**: Исправлены XSS уязвимости при отображении ошибок валидации, заголовков модальных окон и текстов кнопок - все пользовательские данные теперь экранируются через `escapeHtml()`
- **Безопасность JSON.parse**: Добавлена валидация размера данных и обработка ошибок при парсинге JSON в `EventDelegation`
- **Безопасность рендеринга полей**: Все рендереры полей теперь безопасно экранируют HTML во всех местах, где отображается пользовательский ввод

### ⚠️ Важные замечания по безопасности
- **Базовая защита от XSS**: В пакете реализована базовая защита от XSS атак через экранирование HTML во всех стандартных рендерерах полей формы. Однако **настоятельно рекомендуется** использовать дополнительную защиту в вашем приложении:
  - Для кастомных полей (`custom` тип поля) и кастомных рендереров (`ICustomFieldRenderer`) пакет **не может гарантировать** безопасность, так как рендеринг полностью контролируется пользователем. Обязательно используйте санитизацию (например, DOMPurify) при рендеринге HTML в кастомных полях
  - Для пользовательских HTML шаблонов в блоках (когда используется `render.kind === 'template'`) рекомендуется использовать санитизацию HTML, если шаблон может содержать пользовательский ввод
  - Для Vue компонентов в блоках используйте безопасные методы рендеринга (`v-text` вместо `v-html`, если не уверены в источнике данных)
  - Рекомендуется настроить Content Security Policy (CSP) в вашем приложении для дополнительной защиты от XSS атак

---

## [1.0.19] - 2025-01-XX

### Исправлено
- -fix

---

## [1.0.18] - 2025-01-XX

### Исправлено
- -fix

---

## [1.0.17] - 2025-01-04

### Изменено
- **BlockBuilder.vue и UIRenderer.ts**: Добавлен класс `block-builder` к основному контейнеру приложения для улучшения кастомизации стилей
- **_forms.scss**: Удален жестко заданный цвет из `.block-builder-form-label` для лучшей адаптации к темам

---

## [1.0.16] - 2025-01-04

### Исправлено
- **BlockBuilder.vue**: Исправлено отображение ошибок валидации - теперь ошибки показываются для всех типов полей (text, textarea, number, color, url, select, checkbox, radio), а не только для radio полей

---

## [1.0.15] - 2025-01-04

### Удалено
- **Свойство `storageType`**: Удалено свойство `storageType?: 'memory' | 'localStorage'` из `IBlockBuilderOptions` и `BlockBuilderFactory`. Сохранение блоков теперь реализовано исключительно через колбэк `onSave`, который пользователь передаёт в опциях
- **LocalStorageBlockRepositoryImpl**: Удалена реализация репозитория с использованием localStorage. Репозиторий теперь используется только для работы в памяти во время сессии
- **Свойство `collapsible`**: Удалено опциональное свойство `collapsible` из `IRepeaterFieldConfig`. Элементы repeater теперь всегда можно сворачивать/разворачивать (аккордеоны всегда включены)
- **Свойство `locked`**: Удалена функциональность блокировки блоков ("Lock block"). Удалены связанные методы и UI элементы
- **Методы `saveBlocks` и `loadBlocks`**: Удалены из документации как несуществующие публичные методы. Реальное сохранение происходит через колбэк `onSave`, загрузка - через `initialBlocks` prop

### Изменено
- **Валидация `message`**: Поле `message` в правилах валидации (`IValidationRule`, `IBaseValidationRule`) теперь опциональное. Добавлены fallback сообщения по умолчанию для всех типов правил валидации
- **Фильтрация скрытых блоков**: Если блок скрыт (`visible: false`), он автоматически фильтруется и не отображается при `isEdit: false`
- **Замена CSS классов**: Все использования CSS класса `hidden` и `is-hidden` заменены на `CSS_CLASSES.HIDDEN` из `block-builder/src/utils/constants.ts`
- **Унификация стилей**: Все стили из `<style>` секций в `BlockBuilder.vue` и `BlockComponent.vue` перемещены в общие SCSS файлы (`_forms.scss` и `_blocks.scss`)
- **RepeaterControl**: Элементы repeater теперь всегда можно сворачивать/разворачивать (аккордеоны всегда включены). Удалён prop `collapsible` из компонента

### Исправлено
- **RepeaterControl.vue**: Исправлена ошибка `TypeError: Cannot read properties of undefined (reading 'ERROR')` - добавлен `CSS_CLASSES` в возвращаемый объект `setup()` функции
- **Документация**: Исправлена ошибочная информация о `containerId` для core версии - теперь явно указано, что `containerId` НЕ нужен для `@mushket-co/block-builder/core`
- **Документация**: Удалены упоминания устаревших свойств `storage`, `autoRender` из документации. Исправлено на `autoInit`
- **Документация**: Добавлены все пропсы `BlockBuilderComponent` в документацию, удалены расплывчатые формулировки "другие опции..."

### Очистка кода
- Удалены неиспользуемые импорты, комментарии и мусорный код
- Удалена функция `handleCardClick` из `BlockComponent.vue`
- Удалены константы связанные с localStorage (`STORAGE_KEY_BLOCKS`, `STORAGE_QUOTA_EXCEEDED`, `FAILED_TO_LOAD_BLOCKS`, `FAILED_TO_SAVE_BLOCKS`)

---

## [1.0.14] - 2025-11-03

### Добавлено
- **Экспорт `./BlockBuilderFactory` в package.json**: Добавлен новый entry point `./BlockBuilderFactory` для доступа к `ApiSelectUseCase` и связанным типам (`IHttpClient`, `IHttpResponse`, `IHttpRequestOptions`, `IApiRequestParams`) из Pure JS приложений без необходимости импортировать Vue-специфичные модули

### Изменено
- **BlockBuilderFactory.ts**: Добавлены экспорты `ApiSelectUseCase` и связанных типов для использования вне пакета через импорт `@mushket-co/block-builder/BlockBuilderFactory`

---

## [1.0.13] - 2025-11-03

### Добавлено
- **Экспорты CSS в package.json**: Добавлены экспорты `./index.esm.css` и `./index.css` в `package.json`, что позволяет корректно импортировать стили через `import '@mushket-co/block-builder/index.esm.css'` без указания полного пути `dist/index.esm.css`

---

## [1.0.12] - 2025-11-03

### Исправлено
- **Исправлен `.npmignore`**: Убрано исключение всей директории `src/`, которое блокировало включение файлов из `src/ui/` в npm пакет. Теперь все файлы из `src/`, указанные в `files`, корректно включаются в пакет
- **Убрана зависимость от SCSS в Vue компонентах**: Удалены импорты SCSS файлов из Vue компонентов (`@use '../styles/index.scss'` и подобные). Теперь пользователям не нужно устанавливать `sass` - стили уже скомпилированы в `dist/index.esm.css` и должны импортироваться отдельно
- **Исключены SCSS файлы из npm пакета**: Директория `src/ui/styles/` теперь исключена из публикации пакета

---

## [1.0.11] - 2025-11-03

### Исправлено
- **Исправлен список файлов npm пакета**: Теперь включены все необходимые директории (`src/ui/**/*`, `src/core/**/*.ts`) для корректной работы Vue компонентов с их зависимостями (icons, controllers, services и т.д.)

---

## [1.0.10] - 2025-11-03

### Исправлено
- **Добавлены `core/services` и `core/entities` в npm пакет**: Файлы из `src/core/services/` и `src/core/entities/` теперь включены в список файлов пакета, что позволяет Vue компонентам корректно резолвить импорты лицензионных сервисов

---

## [1.0.9] - 2025-11-03

### Исправлено
- **Добавлен `BlockBuilderFactory.ts` в npm пакет**: Файл `src/BlockBuilderFactory.ts` теперь включен в список файлов пакета, что позволяет корректно резолвить импорты при использовании `vue` entry point

---

## [1.0.8] - 2025-11-03

### Исправлено
- **Исправлена проблема с резолвингом импортов в `vue` entry point**: Теперь `createBlockManagementUseCase` корректно работает при установке пакета через npm, добавлен экспорт `BlockBuilderFactory` через `vue.ts` для внешнего использования

### Изменено
- **vue.ts**: Добавлен экспорт `BlockBuilderFactory` и его типов для удобного использования в Vue компонентах

---

## [1.0.7] - 2025-11-03

### Исправлено
- **Исправлена проблема с резолвингом импортов в `vue` entry point**: Теперь `createBlockManagementUseCase` корректно работает при установке пакета через npm, добавлен экспорт `BlockBuilderFactory` через `vue.ts` для внешнего использования

### Изменено
- **vue.ts**: Добавлен экспорт `BlockBuilderFactory` и его типов для удобного использования в Vue компонентах

---

## [1.0.6] - 2025-11-03

### Добавлено
- **Режим редактирования/просмотра**: Добавлен параметр `isEdit` в `BlockBuilderFacade`, который позволяет переключаться между режимом редактирования (по умолчанию `true`) и режимом только просмотра (`false`)
- **API для управления режимом редактирования**: Добавлены методы `setIsEdit(isEdit: boolean)` и `getIsEdit(): boolean` в `BlockBuilderFacade` для динамического переключения режима
- **Условное отображение UI контролов**: В режиме просмотра (`isEdit: false`) автоматически скрываются все кнопки редактирования, добавления и управления блоками. Остаётся доступной только функция копирования ID блока
- **CSS класс `bb-is-edit-mode`**: Автоматически добавляется класс на элемент `body` для возможности кастомизации стилей в зависимости от режима работы

### Изменено
- **BlockBuilderFacade**: Добавлен параметр `isEdit` в интерфейс `IBlockBuilderOptions`, по умолчанию `true`
- **BlockUIController**: Добавлена поддержка режима редактирования, все операции создания/редактирования/удаления блоков блокируются в режиме просмотра
- **UIRenderer**: Обновлён для поддержки условного рендеринга контролов в зависимости от режима редактирования
- **BlockBuilder.vue**: Компонент теперь получает и обрабатывает проп `isEdit` для Vue3 интеграции
- **Примеры использования**: Обновлены примеры в `examples/pure-js-vite`, `examples/vue3` и `examples/pure-js-cdn` для демонстрации использования режима редактирования

### Исправлено
- Улучшена обработка режима просмотра в UI контроллере - все действия, связанные с редактированием, корректно блокируются

---

**Примечание**: Для полной истории изменений см. [git log](https://github.com/mushket-co/block-builder/commits/master).

